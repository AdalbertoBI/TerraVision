<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="cache-control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="0" />
        <meta name="description" content="Terra Vision â€” interface musicoterapÃªutica com controle por olhar e piscada." />
        <title>Terra Vision Â· Interface ocular para mÃºsica terapÃªutica</title>
        <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='15' fill='%2305182b'/%3E%3Cpath d='M16 8a9 9 0 1 0 9 9 9 9 0 0 0-9-9zm0 14a5 5 0 1 1 5-5 5 5 0 0 1-5 5z' fill='%234fc3f7'/%3E%3Ccircle cx='16' cy='17' r='2.5' fill='%23fbc02d'/%3E%3C/svg%3E" />
    <link rel="stylesheet" href="style.css?v=dev" />
    </head>
    <body>
        <noscript>
            <div class="noscript" role="alert">
                Ative o JavaScript para utilizar o Terra Vision com rastreamento ocular.
            </div>
        </noscript>

        <main class="stage" aria-label="Pizza musical interativa">
            <canvas id="pizza-canvas" aria-label="Pizza com notas musicais" role="img"></canvas>
            <button
                type="button"
                class="control-button stage-calibrate"
                data-action="calibrate"
                aria-label="Calibrar rastreamento ocular"
            >
                <span class="control-icon" aria-hidden="true">ðŸŽ¯</span>
                <span class="control-label">Calibrar</span>
                <span class="control-progress" aria-hidden="true"></span>
            </button>
            <div id="gaze-dot" aria-hidden="true"></div>
        </main>

        <section id="status" class="status-bar" role="status" aria-live="polite" aria-atomic="true">
            Olhe para a pizza colorida e use o alvo central para calibrar quando estiver pronto.
        </section>

        <script>
            (function ensureSecureContext() {
                const statusEl = document.getElementById('status');
                const host = window.location.hostname;
                const isLocalhost = host === 'localhost';
                if (window.location.protocol === 'file:') {
                    statusEl && (statusEl.textContent = 'Execute o Terra Vision a partir de um servidor local gratuito (ex.: python -m http.server 8000) em http://localhost para habilitar o rastreamento ocular.');
                } else if (window.location.protocol === 'http:' && host && !isLocalhost) {
                    statusEl && (statusEl.textContent = `Abra o projeto usando a URL http://localhost (endereÃ§o atual: ${host}). O WebGazer sÃ³ funciona em https ou localhost.`);
                }
            })();
        </script>
        <script>
            (function loadWebGazer() {
                const statusEl = document.getElementById('status');
                const host = window.location.hostname;
                const isLocalEnv = ['localhost', '127.0.0.1', ''].includes(host) || window.location.protocol === 'file:';

                const sources = [];
                if (isLocalEnv) {
                    sources.push({ src: 'libs/webgazer.js', label: 'biblioteca local', critical: true });
                }
                sources.push(
                    { src: 'https://cdn.jsdelivr.net/npm/webgazer/dist/webgazer.min.js', label: 'jsDelivr' },
                    { src: 'https://unpkg.com/webgazer/dist/webgazer.min.js', label: 'unpkg' }
                );

                function inject(index) {
                    if (index >= sources.length) {
                        console.error('WebGazer nÃ£o pÃ´de ser carregado de nenhuma origem disponÃ­vel.');
                        return;
                    }

                    const entry = sources[index];
                    const script = document.createElement('script');
                    const cacheBustingSrc = `${entry.src}${entry.src.includes('?') ? '&' : '?'}_=${Date.now()}`;
                    script.src = cacheBustingSrc;
                    script.crossOrigin = 'anonymous';
                    script.async = false;
                    script.onload = () => {
                        console.info(`WebGazer carregado de ${entry.label}.`);
                    };
                    script.onerror = () => {
                        console.warn(`Falha ao carregar WebGazer a partir de ${entry.label}.`);
                        if (entry.label === 'biblioteca local') {
                            console.warn('Execute script/setup-webgazer.(bat|sh) para baixar a versÃ£o livre do WebGazer no diretÃ³rio libs/ quando estiver desenvolvendo offline.');
                            statusEl && (statusEl.textContent = 'Instale o WebGazer local executando script/setup-webgazer.(bat|sh) ou baixe https://github.com/brownhci/WebGazer e coloque em libs/webgazer.js para uso offline.');
                        }
                        inject(index + 1);
                    };
                    document.head.appendChild(script);
                }

                inject(0);
            })();
        </script>
    <script src="src/main.js?v=dev" type="module" defer></script>
    </body>
</html>
