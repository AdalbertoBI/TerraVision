<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="cache-control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="0" />
        <meta name="description" content="Terra Vision — interface musicoterapêutica com controle por olhar e piscada." />
        <title>Terra Vision · Interface ocular para música terapêutica</title>
        <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='15' fill='%2305182b'/%3E%3Cpath d='M16 8a9 9 0 1 0 9 9 9 9 0 0 0-9-9zm0 14a5 5 0 1 1 5-5 5 5 0 0 1-5 5z' fill='%234fc3f7'/%3E%3Ccircle cx='16' cy='17' r='2.5' fill='%23fbc02d'/%3E%3C/svg%3E" />
        <link rel="stylesheet" href="style.css?v=dev" />
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" defer></script>
    <script id="webgazer-preload" src="libs/webgazer.js" defer></script>
    </head>
    <body>
        <div
            id="gaze-cursor"
            style="position: fixed; width: 20px; height: 20px; background: rgba(255,0,0,0.7); border-radius: 50%; pointer-events: none; z-index: 1000; display: none; left: 0; top: 0; transform: translate(-50%, -50%);"
            aria-hidden="true"
        ></div>
        <canvas id="roi-canvas" width="240" height="120" aria-hidden="true"></canvas>
        <noscript>
            <div class="noscript" role="alert">
                Ative o JavaScript para utilizar o Terra Vision com rastreamento ocular.
            </div>
        </noscript>

        <main class="stage" aria-label="Pizza musical interativa">
            <canvas id="pizza-canvas" aria-label="Pizza com notas musicais" role="img"></canvas>
            <canvas id="heatmap-canvas" aria-hidden="true"></canvas>
            <div class="stage-center">
                <video
                    id="webcam"
                    autoplay
                    muted
                    playsinline
                    width="640"
                    height="480"
                    aria-label="Pré-visualização da câmera frontal"
                ></video>
            </div>
            <div id="gaze-dot" aria-hidden="true"></div>
        </main>

        <div
            id="animated-eye-container"
            style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 500; display: none;"
            aria-hidden="true"
        >
            <svg viewBox="-50 0 350 235" width="200" height="150" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <radialGradient id="eyeball-gradient">
                        <stop offset="60%" stop-color="#dcdae0" />
                        <stop offset="100%" stop-color="#a8a7ad" />
                    </radialGradient>
                    <radialGradient id="pupil-gradient" cx="0.35" cy="0.35" r="0.65">
                        <stop offset="0%" stop-color="#444" />
                        <stop offset="75%" stop-color="#000" />
                        <stop offset="100%" stop-color="#000" />
                    </radialGradient>
                    <filter id="pupil-blur"><feGaussianBlur stdDeviation="0.75" /></filter>
                </defs>
                <ellipse cx="131" cy="117.5" rx="100" ry="65" fill="url(#eyeball-gradient)" />
                <g id="pupil-group">
                    <ellipse id="pupil" cx="131" cy="117.5" rx="50" ry="50" fill="url(#pupil-gradient)" filter="url(#pupil-blur)" />
                    <circle id="pupil-reflection" cx="111" cy="102.5" r="5" fill="white" />
                    <circle id="pupil-reflection-small" cx="124" cy="102.5" r="3" fill="white" />
                </g>
                <path id="upper-eyelid" d="M128.5 53.5C59.3 55.5 33 99.6667 28.5 121.5H0V0L261.5 0V121.5H227.5C214.7 65.1 156.167 52.6667 128.5 53.5Z" fill="#000" />
                <path id="lower-eyelid" d="M128.5 181C59.3 179 33 134.833 28.5 113H0V234.5H261.5V113H227.5C214.7 169.4 156.167 181.833 128.5 181Z" fill="#000" />
            </svg>
        </div>

        <section id="status" class="status-bar" role="status" aria-live="polite" aria-atomic="true">
            <span id="status-text">
                Olhe para a pizza colorida e clique onde estiver olhando para ensinar o sistema passivamente. Piscadas após o clique reforçam o aprendizado.
            </span>
        </section>

        <script>
            (function ensureSecureContext() {
                const statusEl = document.getElementById('status');
                const statusText = document.getElementById('status-text');
                const host = window.location.hostname;
                const isLocalhost = host === 'localhost';
                if (window.location.protocol === 'file:') {
                    statusText && (statusText.textContent = 'Execute o Terra Vision a partir de um servidor local gratuito (ex.: python -m http.server 8000) em http://localhost para habilitar o rastreamento ocular.');
                } else if (window.location.protocol === 'http:' && host && !isLocalhost) {
                    statusText && (statusText.textContent = `Abra o projeto usando a URL http://localhost (endereço atual: ${host}). O WebGazer só funciona em https ou localhost.`);
                }
            })();
            window.addEventListener('DOMContentLoaded', () => {
                const statusText = document.getElementById('status-text');
                if (document.body.dataset.webgazerMissing === 'true' && statusText) {
                    statusText.textContent = 'Arquivo libs/webgazer.js não encontrado. Execute o script setup-webgazer.bat ou .sh para baixar a versão local.';
                }
            });
        </script>
    <script src="src/main.js?v=dev" type="module" defer></script>
    </body>
</html>
